<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>bo.blog - thoughts</title><link href="/" rel="alternate"></link><link href="/feeds/thoughts.atom.xml" rel="self"></link><id>/</id><updated>2021-03-29T20:55:00+02:00</updated><entry><title>Before building a Neural Search Application, Build your Mind Map first</title><link href="/before-building-a-neural-search-application-build-your-mind-map-first.html" rel="alternate"></link><published>2021-03-29T20:55:00+02:00</published><updated>2021-03-29T20:55:00+02:00</updated><author><name>Bo Wang</name></author><id>tag:None,2021-03-29:/before-building-a-neural-search-application-build-your-mind-map-first.html</id><summary type="html">&lt;p&gt;design first, implementation second&lt;/p&gt;</summary><content type="html">&lt;p&gt;Recently when answering questions from &lt;a href="https://github.com/jina-ai/jina"&gt;Jina&lt;/a&gt; community users,
I found a lot of developers want to build something fancy, for example:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;build a cross-modal search system, use text to search image without labeled data.&lt;/li&gt;
&lt;li&gt;build a cross-lingual search system, use Dutch to search products list in German markets.&lt;/li&gt;
&lt;li&gt;build a multi-modal search system, where query could be multi-modality, such as user &lt;strong&gt;Query&lt;/strong&gt; contains a piece of text plus image and &lt;strong&gt;Documents&lt;/strong&gt; are products which are semi-structured texts and images.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;While they're not sure about what they can do and what Jina can offer.
As someone actively working for Jina and using Jina to build solutions,
my first suggestion is:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Before building a Neural Search Application, Build your Mind Map first&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;In the programming/software engineering world,
you might always been told to "get your hands dirty".
This could be true in a lot of domains,
but not for neural search.&lt;/p&gt;
&lt;p&gt;Building a traditional search system using Solr/Elasticsearch is intuitive:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;You know your input: text queries.&lt;/li&gt;
&lt;li&gt;You (don't have to)know what the "analyzers" will do: such as &lt;em&gt;tokenize&lt;/em&gt;, &lt;em&gt;stemming&lt;/em&gt;, &lt;em&gt;lemmatization&lt;/em&gt;.&lt;/li&gt;
&lt;li&gt;You (don't have to)know what the "algorithm" will do: such as penalize the score of frequent tokens will assign higher scores to rare tokens.&lt;/li&gt;
&lt;li&gt;You 100% percent know that if there is a document &lt;strong&gt;match&lt;/strong&gt; your &lt;strong&gt;Query&lt;/strong&gt;, it will appear in your ranking list.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Essentially, algorithms behind Solr/Elastic such as tf-idf, okapi bm25 are some form of advanced &lt;strong&gt;boolean retrieval&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;However, for neural search, it's another story.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Your &lt;strong&gt;Query&lt;/strong&gt; could be complicated: text, image, video, DNA sequence, or combination of different forms.&lt;/li&gt;
&lt;li&gt;Given the fact of the &lt;strong&gt;Query&lt;/strong&gt; and &lt;strong&gt;Documents&lt;/strong&gt; could be uni-modal, or multi-modal, we can hardly provide a standard set of &lt;em&gt;analyzers&lt;/em&gt;, such as what &lt;a href="https://lucene.apache.org/core/4_0_0/analyzers-common/org/apache/lucene/analysis/en/package-summary.html"&gt;Lucene can offer&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;The deep learning model is picky. For instance, you have to carefully switch image &lt;code&gt;channel_axis&lt;/code&gt; to match the library you're using. Or you have to carefully &lt;code&gt;collate&lt;/code&gt; your tokens before feeding it into the model.&lt;/li&gt;
&lt;li&gt;The deep learning model is fragile. Pre-trained model could hardly bring quality results in your business domain.&lt;/li&gt;
&lt;li&gt;Similarity matching is time-consuming. Imaging compute cosine similarity using 1 &lt;strong&gt;Query&lt;/strong&gt; against 1 million &lt;strong&gt;Documents&lt;/strong&gt; (products) and keep in mind, your're building a search application. User expect to get the result in seconds.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Then it becomes tricky to manage this level of complexity.&lt;/p&gt;
&lt;p&gt;How easy it is to delegate this complexity to Jina?
Years ago I spend around 15 minutes to learn the syntax of Markdown, it is as easy as Markdown.&lt;/p&gt;
&lt;p&gt;Let's say, you want to build a search application (this is a real use-case) that:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;receive 3 categories of dataset: finance, HR and sales.&lt;/li&gt;
&lt;li&gt;process them separately.&lt;/li&gt;
&lt;li&gt;indexing them separately.&lt;/li&gt;
&lt;li&gt;search across three indices and aggregate best matches to the user.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The &lt;strong&gt;Documents&lt;/strong&gt; might look like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;docarray&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;DocumentArray&lt;/span&gt;

&lt;span class="n"&gt;da&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;DocumentArray&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;da&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;this is a finance document&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;finance&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}))&lt;/span&gt;
&lt;span class="n"&gt;da&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;this is a HR document&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;hr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}))&lt;/span&gt;
&lt;span class="n"&gt;da&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;this is a sales document&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sales&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}))&lt;/span&gt;
&lt;span class="c1"&gt;# ... you have much more&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h1&gt;The naive approach&lt;/h1&gt;
&lt;p&gt;In the first iteration,
I'll do it naively.
I set up 3 &lt;code&gt;Flows&lt;/code&gt;,
&lt;code&gt;Flows&lt;/code&gt; first filter the &lt;code&gt;Documents&lt;/code&gt; based on their category,
then employ a dedicated &lt;code&gt;Processor&lt;/code&gt; to pre-processing the filtered data based on the &lt;code&gt;category&lt;/code&gt;.
Afterwards, use a common &lt;code&gt;Indexer&lt;/code&gt;.
The &lt;code&gt;Indexer&lt;/code&gt; takes a &lt;code&gt;connection_str&lt;/code&gt; as parameter to save embeddings to different vector databases.
To this end, deploy 3 Flows as 3 K8s deployments,
collect results from 3 micro-services and aggregate the final ranking results.&lt;/p&gt;
&lt;p&gt;Sounds not bad:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jina&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Executor&lt;/span&gt;

&lt;span class="n"&gt;flow_finance&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;finance&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-finance-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;flow_hr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;hr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-hr-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;flow_sales&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sales&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-sales-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;if you call &lt;code&gt;flow_finance.plot()&lt;/code&gt; you'll get:&lt;/p&gt;
&lt;p&gt;&lt;img alt="naive" src="images/naive.svg"&gt;&lt;/p&gt;
&lt;p&gt;You'll get the same thing when calling &lt;code&gt;flow_hr.plot()&lt;/code&gt; or &lt;code&gt;flow_sales.plot()&lt;/code&gt;, the only difference is the naming.
Is it working? Yes! But not elegant.&lt;/p&gt;
&lt;p&gt;One important concept you can get from a &lt;code&gt;Flow&lt;/code&gt; and you might miss is the idea of &lt;code&gt;pathway&lt;/code&gt;. Let's do it better!&lt;/p&gt;
&lt;h1&gt;The Better Approach&lt;/h1&gt;
&lt;p&gt;A &lt;code&gt;pathway&lt;/code&gt; is something not an official concept in Jina, but widely used to compose a multi-modal application.
Imaging your are building a multi-modal search application with both Image and Text, then you can split your &lt;code&gt;Flow&lt;/code&gt;
into 2 &lt;code&gt;pathways&lt;/code&gt;: one for Image and one for Text.
It is the same idea here:&lt;/p&gt;
&lt;p&gt;We use the &lt;code&gt;Filter&lt;/code&gt; 3 times  and allow dedicated &lt;code&gt;Processsors&lt;/code&gt; follow the &lt;code&gt;pathway&lt;/code&gt; of each &lt;code&gt;Filter&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jina&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Executor&lt;/span&gt;

&lt;span class="n"&gt;flow&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;finance&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;finance&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gateway&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;finance&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gateway&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_filter&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-finance-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-hr-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-sales-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gather_all&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;hr_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sales_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;flow&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;As you can see in the above code, rather than creating the &lt;code&gt;Flow&lt;/code&gt; 3 times, we follow the idea if &lt;code&gt;pathway&lt;/code&gt;.
The key is the argument &lt;code&gt;needs&lt;/code&gt;: it defines which &lt;code&gt;pathway&lt;/code&gt; should I follow.
For example: the &lt;code&gt;hr_data_processor&lt;/code&gt; process filtered HR data, so &lt;code&gt;needs=['hr_data_filter']&lt;/code&gt;.
&lt;code&gt;needs&lt;/code&gt; could be either a sinlge string, or a list of string.
The last &lt;code&gt;gather_all&lt;/code&gt; endpoints waits for all 3 &lt;code&gt;indexers&lt;/code&gt; finish then produce the final ranking list.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;em&gt;NOTE:&lt;/em&gt;&lt;/strong&gt;  The default &lt;code&gt;needs&lt;/code&gt; is always the previous Executor. The starting and ending point are always the &lt;code&gt;gateway&lt;/code&gt;. &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The &lt;code&gt;flow&lt;/code&gt; looks like this:&lt;/p&gt;
&lt;p&gt;&lt;img alt="better" src="images/better.svg"&gt;&lt;/p&gt;
&lt;h1&gt;The Fancy Approach&lt;/h1&gt;
&lt;p&gt;It is always interesting to explore the &lt;a href="https://docs.jina.ai/"&gt;Jina documentation&lt;/a&gt;.
If you do so you might figure out something called &lt;a href="https://docs.jina.ai/how-to/flow-switch/#how-to-build-switches-in-a-flow"&gt;Flow switches&lt;/a&gt;.
It allows you to &lt;strong&gt;conditionally filter data based on your needs&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;In our previous example, &lt;code&gt;finance_data_processor&lt;/code&gt; works only if the &lt;code&gt;Document&lt;/code&gt; category is &lt;code&gt;finance&lt;/code&gt;,
this also applies to &lt;code&gt;hr_data_filter&lt;/code&gt; and &lt;code&gt;sales_data_filter&lt;/code&gt;.
Lucky, you can use the &lt;code&gt;when&lt;/code&gt; semantic in the &lt;code&gt;Flow&lt;/code&gt; to filter the data conditional:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;jina&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Executor&lt;/span&gt;

&lt;span class="n"&gt;flow&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;Flow&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;when&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tags__category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;$eq&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;finance&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}})&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;when&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tags__category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;$eq&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;hr&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gateway&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;when&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;tags__category&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;$eq&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sales&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gateway&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-finance-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-hr-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hr_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;uses_with&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;connection_str&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;my-host-to-sales-db:port@user/password&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sales_data_processor&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
          &lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gather_all&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;needs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;finance_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;hr_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;sales_data_indexer&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;flow&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plot&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Once we applied &lt;code&gt;when&lt;/code&gt; argument here, the &lt;code&gt;Executor&lt;/code&gt; will only applies if the condition is meet.
For instance, &lt;code&gt;hr_data_processor&lt;/code&gt; only works if the &lt;code&gt;category&lt;/code&gt; of &lt;code&gt;Document.tags['category']==hr&lt;/code&gt;.
Think about how much this feature will bring you, imaging you only want to do some processing when some product price is greater than 500 euro,
then you can simply apply this executor with &lt;code&gt;when={'tags__price': {'$gt': 500}}&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img alt="best" src="images/best.svg"&gt;&lt;/p&gt;
&lt;h1&gt;Final Words&lt;/h1&gt;
&lt;p&gt;Building a neural search application is not easy,
but it brings a lot of values and open tremendous opportunities to your business.
Before getting your hands dirty,
I strongly suggest use your favourite tool to design your mind map,
such as what is your system input, output, what are the necessary building blocks.&lt;/p&gt;
&lt;p&gt;In the above examples, you noticed i only defined the &lt;code&gt;Flow&lt;/code&gt; , it's &lt;code&gt;Executors&lt;/code&gt; and the relationship between &lt;code&gt;Flows&lt;/code&gt;.
Once you believe this is the best design, you could start to start the real coding. i.e. implement the code behind each &lt;code&gt;Executors&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Last but not least, I want to share a "mind map" I designed for a real-world user for multi-modal fashion product search.
That's it for today.
&lt;img alt="real" src="images/realworld.svg"&gt;&lt;/p&gt;</content><category term="thoughts"></category><category term="information retrieval"></category></entry><entry><title>Metric-Learning vs Self-Supervised Learning, which produce better embeddings for Instance Retrieval?</title><link href="/metric-learning-vs-self-supervised-learning-which-produce-better-embeddings-for-instance-retrieval.html" rel="alternate"></link><published>2021-03-20T22:17:00+01:00</published><updated>2021-03-20T22:17:00+01:00</updated><author><name>Bo Wang</name></author><id>tag:None,2021-03-20:/metric-learning-vs-self-supervised-learning-which-produce-better-embeddings-for-instance-retrieval.html</id><summary type="html">&lt;p&gt;This is the first article I published on this topic. Which generally lay the foundation of the question.&lt;/p&gt;</summary><content type="html">&lt;p&gt;Instance-level image retrieval is an important component of image retrieval tasks.
Given an image as &lt;em&gt;Query&lt;/em&gt;,
an instance retrieval system aims at find the same objects &lt;em&gt;D&lt;/em&gt; with respect to &lt;em&gt;Q&lt;/em&gt;.
For instance, given an image of the Great Wall, instance retrieval should be able to find other Great Wall images,
under different circumstances.
Or return facial images of the same person while querying with another facial image of a celebrity.&lt;/p&gt;
&lt;p&gt;For a long period of time, (Supervised)Metric-Learning has always been the answer:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Prepare a training set, with class labels.&lt;/li&gt;
&lt;li&gt;Construct triplets (or tuples, or more..), each triplet contains an anchor image, a positive and a negative.&lt;/li&gt;
&lt;li&gt;Apply triplet margin loss by maximizing the distance metric between anchor and negative pair, while pull anchor and positive closer.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="triplet" src="images/triplet_loss.png"&gt;
&lt;em&gt;source: &lt;a href="https://arxiv.org/abs/1503.03832"&gt;FaceNet: A Unified Embedding for Face Recognition and Clustering&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Apparently, supervised deep metric learning is more than that.
In the past months, while developing &lt;a href="https://github.com/jina-ai/finetuner"&gt;Finetuner&lt;/a&gt; at Jina AI,
we went through a lot of traps.&lt;/p&gt;
&lt;p&gt;For instance, Should we allow user to manually create "hard-negatives"?
The answer is a clear No.
But in the first iteration,
the input of our data is &lt;em&gt;Document&lt;/em&gt; with 2 &lt;em&gt;Matches&lt;/em&gt; like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;docarray&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Document&lt;/span&gt;

&lt;span class="n"&gt;anchor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;uri&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;this-is-the-anchor-image.jpg&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;pos&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;uri&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;this-is-an-positive-image&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;label&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="c1"&gt;# positive share the same label as anchor&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;neg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Document&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;uri&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;this-is-a-negative-image&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;label&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="c1"&gt;# negative has an different label &lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;anchor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;matches&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;extend&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;pos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;neg&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This "gives" user the power to perform manual positive/negative selection.
However, does it make any sense?
Probably not for several reasons:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;It takes efforts for users to perform negative mining, in another word,  it take times.&lt;/li&gt;
&lt;li&gt;Since it might takes time, user might just randomly sampling negatives from other classes.&lt;/li&gt;
&lt;li&gt;Negative samples might not being effectively used. Suppose user select 1 positive 4 negatives, we end up with 4 triplets, not much, quantity wise.&lt;/li&gt;
&lt;li&gt;Negative samples might not being selected has hard-negatives, given in most cases, hard-negatives brings more benefits while model training.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;What is the better approach?
Do it automatically!&lt;/p&gt;
&lt;p&gt;Suppose you have a deep metric learning training task,
your batch size is 128,
this is what we offer you:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;For each batch of 128 samples, we sample N items from the same class, e.g. 4. In the end, you got 32 classes within batch.&lt;/li&gt;
&lt;li&gt;Consider each item as an anchor image, then you get 3 positives (4 - 1).&lt;/li&gt;
&lt;li&gt;Consider each item as an anchor image, then you get 124 negatives (128 - 3 - 1).&lt;/li&gt;
&lt;li&gt;In the end, within this batch, how many triplets you get? Much larger than 4 if we perform manual negative selection (1 anchor-1 pos-4 neg)!&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Now you have a set of triplets, you can either:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Training your model with all automatically selected triplets (with no mining).&lt;/li&gt;
&lt;li&gt;Training your model with different mining strategies (easy/semi-hard/hard negative mining).&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This makes training a metric learning model much more effectively.
While you might still discover some minor issues:&lt;/p&gt;
&lt;p&gt;If we want to apply hard-negative mining,
and if I can only perform hard-negative mining within the batch,
this means I can only select the "best" hard-negative within a batch,
not over the entire dataset.&lt;/p&gt;
&lt;p&gt;This is true, and 2 possible solutions: either you increase your batch size to generate a bigger "pool size" and reduce the issue,
or you perform cross-batch hard-negative mining.
Previous solution is easier,
while could be limited by your hard-ware capacity.
After all, GPU-memory is too limited compare with RAM.
The later strategy, could resolve the issue.
While it is tricky to bring the code into a reusable component of a software.&lt;/p&gt;
&lt;p&gt;We've approved that deep metric learning + triplet margin loss + sampling + hard-negative mining is extremely useful,
and, it is especially the case,
for instance-level image retrieval.&lt;/p&gt;
&lt;p&gt;Since 2018, Google launched &lt;a href="https://www.kaggle.com/c/landmark-retrieval-2021"&gt;Google Landmark Retrieval 2021&lt;/a&gt;.
This is a perfect playground for instance-level image retrieval.&lt;/p&gt;
&lt;p&gt;If you look at the top solutions, almost all of them use deep metric learning and some add-on tricks.
Includes different loss functions, pooling layers etc.
Nothing other than deep metric learning.
The latest winner,
according to leaderboard,
reached a mAP@100 of &lt;strong&gt;0.53751&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;If you employ a pre-trained ResNet/EfficientNet trained on ImageNet dataset,
remove the last classification layer and turn it into a &lt;strong&gt;Embedding model&lt;/strong&gt; (feature extractor),
you can get roughly &lt;strong&gt;0.25 - 0.30&lt;/strong&gt; mAP@100.
Quite significant improvement, right?&lt;/p&gt;
&lt;p&gt;To now, we've discussed the basic idea of deep metric learning and how good it performs on Instance Retrieval task.
You might ask, what about self-supervised learning (SSL), are you still going to mention that?
I say yes, this is the turning point.&lt;/p&gt;
&lt;p&gt;SSL has been a part of representation learning for some time.
But we discovered significant progress has been made in the year of 2021.
Such as SimCLR, SImCLRv2, MoCo, MocoV2, BYOL etc.
These approaches aimes at learn a good representation (embedding model) with NO labels.
&lt;strong&gt;AND THIS IS HUGE IN REAL-WORLD CASES&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;As a machine learning engineer,
How many times have you tried to convince your BOSS the importance of the labeling?
How many times have you tried to label by yourself?
Have you tried convince your manager to spend some money on crowdsourcing platforms to get labels for you?
Are you tired of, build a user-in-the-loop pipeline to deploy a not-perfect model first, and expect to collect more labels as time pass by?&lt;/p&gt;
&lt;p&gt;If non of above make any sense to you, good for you.
But, what inspiring me most, is finally,
we have a SSL paper evaluated on Instance Retrieval Task!
This is published by facebook: &lt;a href="https://arxiv.org/pdf/2104.14294.pdf"&gt;Emerging Properties in Self-Supervised Vision Transformers&lt;/a&gt;.
We'll call it &lt;strong&gt;DINO&lt;/strong&gt; in the following section.
Let's first see some evaluation result:&lt;/p&gt;
&lt;p&gt;&lt;img alt="dino" src="images/eval_dino"&gt;&lt;/p&gt;
&lt;p&gt;If you look at the results without reading the paper,
it might confuse you.
Basically, they trained the model on Google Landmark Dataset we mentioned above.
While evaluated results on Oxford and Paris dataset (another 2 smaller version of landmark datasets).
And they claim the results are even better than some supervised approaches.&lt;/p&gt;
&lt;p&gt;How did they achieve it without using any labels?&lt;/p&gt;
&lt;p&gt;Trick1: Multi-stage cropping. The basic idea of self-supervised learning is,
given an image, it apply augmentation on this image two times,
and generate 2 different &lt;em&gt;Views&lt;/em&gt; of the same image.
Even through these two different &lt;em&gt;Views&lt;/em&gt; of the same image looks different,
but we know they're from the same classes: we augmented the image.
Multi-stage cropping is another step: we crop the input image, let's say 6 times.
2 times we use &lt;strong&gt;Global Cropping&lt;/strong&gt; and we perform &lt;strong&gt;Local Cropping&lt;/strong&gt; 4 times.
Global cropping basically crops over 50% percent of the original image,
while local cropping crops around 20-30% of the original image.
After cropping, we transform the &lt;strong&gt;GlobalCropping&lt;/strong&gt; back to 224 by 224,
&lt;strong&gt;LocalCropping&lt;/strong&gt; to 96 by 96.&lt;/p&gt;
&lt;p&gt;Trick2: Patches and Vision Transformer. Once augmentation finished,
we split the images into patches (a small portion of the augmented image).
Feed patches as inputs to a Vision Transformer model.
The final &lt;strong&gt;[CLS]&lt;/strong&gt; token of 768d becomes the learned representation.&lt;/p&gt;
&lt;p&gt;Trick3: Self-distillation and momentum update. Distillation normally involves 2 models,
one smaller-sized student model and one larger sized teacher model.
For DINO, the author used two identical models (ViT) for both student and teacher.
While apply stop-gradient for teacher model (no back backpropagation),
while update teacher model in an exponential moving average manner.
EMA places a greater weight and significance on the most recent data points.
At early stage, student network post a bit more significant impact on teacher networks' parameters.
As training goes on, the student network has less-and-less impact on teacher network, until training finish.&lt;/p&gt;
&lt;p&gt;Trick4: Centering and Sharpening. According to previous SSL research,
when training model with no negative samples (only tuples) can result in model collapse.
The model can not distinguish which is good,
which is bad since we only have positive samples.
The author introduced Centering parameter &lt;strong&gt;C&lt;/strong&gt; to keep the running average of the rated teacher network ouputs.
And applied always deduct this running average when computing normalized cross-entropy loss.&lt;/p&gt;
&lt;p&gt;How does is final representation looks like?&lt;/p&gt;
&lt;p&gt;&lt;img alt="dino-representation" src="images/attention_maps.png"&gt;&lt;/p&gt;
&lt;p&gt;Training models without labels,
for representation learning,
evaluated on search task,
and get very impressive results.
These are the reasons I consider SSL could becomes a game changer.&lt;/p&gt;
&lt;p&gt;How? It might change the way we deploy ML solutions for varies downstream tasks,
such as search task.
Currently, when user has limited amount of training data,
the best situation seems to be:
Use pre-trained model, freeze most of the layers, apply transfer learning + metric learning for model finetunning.&lt;/p&gt;
&lt;p&gt;Suppose user provided large amount of messy training data without any labels,
what can you do?
The only possible way seems to be: combine &lt;strong&gt;Active Learning&lt;/strong&gt; and &lt;strong&gt;Transfer Learning&lt;/strong&gt;.
User label the data interactively to provide labeled training samples.
This could be useful, but lack of theoretical evaluations and practical support.&lt;/p&gt;
&lt;p&gt;One would argue, in most of my use cases,
I always have labeled data.
This could be a valid point in today's search industries.
But to now, when applying deep learning on image retrieval,
the market is super biased towards to fashion industry,
and this industry, has a lot of labeled data already.&lt;/p&gt;
&lt;p&gt;While I believe, with time pass by,
we'll soon see the shift of vector search from fashion, to more fields.
Such as retail, tourism, real-estate, 3d meshes etc.
Is our data/model ready for these industries already?
The answer is clearly a no.&lt;/p&gt;
&lt;p&gt;Think from another point, what if, the self-supervised learning approaches,
without any supervision, could bring on-par performance compared with supervised approaches?
It's gonna an interesting case,
then the only point for using metric-learning is because it's faster and consume less time/power.&lt;/p&gt;
&lt;p&gt;Stop from here.
In the next blog, I'll write another one brings more code and quantitative evaluation.
We'll get some better understanding of SSL vs Metric Learning by conducting some inspection on their failure cases.&lt;/p&gt;</content><category term="thoughts"></category><category term="representation learning"></category><category term="instance retrieval"></category><category term="image retrieval"></category><category term="metric learning"></category></entry></feed>